# ARC - システムアーキテクチャ設計

**バージョン**: 1.0  
**最終更新**: 2025年10月27日

---

## 1. 全体構成図

```
┌─────────────────────────────────────────────────────────────┐
│                       USER INTERFACE                         │
│  (チャット / 音声 / 1日サマリー / 研究メモリビュー)              │
└────────────────────┬────────────────────────────────────────┘
                     │
         ┌───────────┴───────────┐
         │   Orchestration Layer  │
         │   (中央調整レイヤー)    │
         └───────────┬───────────┘
                     │
     ┌───────────────┼───────────────┐
     │               │               │
┌────▼─────┐  ┌─────▼──────┐  ┌────▼──────┐
│ Module A │  │  Module B  │  │ Module C  │
│   Life   │  │  Research  │  │  Social   │
│ Support  │  │   Memory   │  │ Interface │
└────┬─────┘  └─────┬──────┘  └────┬──────┘
     │               │               │
     └───────────────┼───────────────┘
                     │
         ┌───────────▼───────────┐
         │   Data Storage Layer   │
         │  (ローカル暗号化DB)     │
         └───────────┬───────────┘
                     │
         ┌───────────▼───────────┐
         │     LLM / AI Layer     │
         │  (OpenAI / ローカル)    │
         └───────────────────────┘
```

---

## 2. レイヤー構成

### 2.1 UI Layer
**責務**: ユーザーとの対話・表示

**コンポーネント**:
- チャットインターフェース（メイン）
- 音声読み上げ機能（オプショナル）
- ダッシュボード
  - 1日サマリー
  - 研究メモリビュー
  - タスクビュー（1つだけ表示）

**技術候補**:
- Web: React / Vue.js + Electron (デスクトップ化)
- モバイル: React Native / Flutter
- 音声: Web Speech API / Azure Speech

---

### 2.2 Orchestration Layer
**責務**: モジュール間の調整・ルーティング

**主な機能**:
- ユーザー入力の分類（A/B/Cどのモジュールに渡すか）
- モジュール間のデータ共有
- 定期実行ジョブの管理
  - 朝の問い提示
  - 夜の体調確認
  - 危機検知のモニタリング

**実装方式**:
- Node.js / Python
- スケジューラー: node-cron / APScheduler

---

### 2.3 Module A: Life Support
**責務**: 生存維持・危機介入

**内部構成**:
```
┌─────────────────────────────────┐
│       Input Handler             │
│  (睡眠/食事/しんどさスコア)      │
└──────────┬──────────────────────┘
           │
┌──────────▼──────────────────────┐
│     Crisis Detection Engine     │
│  - 閾値チェック                  │
│  - パーソナライズ学習            │
│  - 緊急度判定                    │
└──────────┬──────────────────────┘
           │
┌──────────▼──────────────────────┐
│   Intervention Generator        │
│  - 許可メッセージ生成            │
│  - リカバリー提案                │
│  - 導線提示（相談窓口）          │
└──────────┬──────────────────────┘
           │
┌──────────▼──────────────────────┐
│      Log & Analytics            │
│  - 日次サマリー                  │
│  - 月次レポート                  │
└─────────────────────────────────┘
```

**データベーステーブル**:
- `life_logs` (id, date, sleep_hours, meal_count, stress_score, crisis_flag, intervention_given)
- `user_thresholds` (user_id, param_name, threshold_value, learned_at)

---

### 2.4 Module B: Research Memory
**責務**: 問いの保持・再提示・昇華

**内部構成**:
```
┌─────────────────────────────────┐
│       Fragment Collector        │
│  (断片的な入力を受け取る)        │
└──────────┬──────────────────────┘
           │
┌──────────▼──────────────────────┐
│      Concept Extractor          │
│  - 繰り返し出る単語/テーマ抽出   │
│  - 感情タグ付け(怒り/違和感)     │
│  - コンテキスト保持              │
└──────────┬──────────────────────┘
           │
┌──────────▼──────────────────────┐
│     Core Theme Identifier       │
│  - "あなたの核"を特定            │
│  - 時系列でテーマの進化を追跡    │
└──────────┬──────────────────────┘
           │
┌──────────▼──────────────────────┐
│    Re-presentation Engine       │
│  - 1日1問い返し                  │
│  - スナップショット生成          │
│  - 論文/申請用ドラフト生成       │
└─────────────────────────────────┘
```

**データベーステーブル**:
- `research_fragments` (id, user_id, content, emotion_tag, context, created_at)
- `core_themes` (id, user_id, theme_name, fragments_refs, frequency, last_shown)
- `snapshots` (id, user_id, generated_text, purpose, created_at)

---

### 2.5 Module C: Social Interface
**責務**: 外部接続の維持・書類生成

**内部構成**:
```
┌─────────────────────────────────┐
│       Deadline Tracker          │
│  - 〆切リスト管理                │
│  - 優先度自動算出                │
└──────────┬──────────────────────┘
           │
┌──────────▼──────────────────────┐
│   Priority Selector             │
│  - 今日やるべき1つだけ選定       │
└──────────┬──────────────────────┘
           │
┌──────────▼──────────────────────┐
│  Document Draft Generator       │
│  - 研究メモリ(B)から素材引用     │
│  - 申請書フォーマットに整形      │
│  - メール骨子生成                │
└──────────┬──────────────────────┘
           │
┌──────────▼──────────────────────┐
│    Submission Tracker           │
│  - 提出済み/未提出の状態管理     │
└─────────────────────────────────┘
```

**データベーステーブル**:
- `deadlines` (id, user_id, title, due_date, category, priority_score, status)
- `documents` (id, user_id, deadline_id, draft_text, final_text, submitted_at)
- `contacts` (id, user_id, name, role, last_contact)

---

## 3. データストレージ設計

### 3.1 データベース選択

**候補**:
- SQLite（ローカル優先・暗号化拡張あり）
- PostgreSQL（将来的なクラウド同期を想定する場合）

**暗号化**:
- SQLCipher (SQLiteの暗号化版)
- マスターキーはユーザーパスワード派生

### 3.2 データフロー

```
[ユーザー入力]
    ↓
[Orchestrator] → 分類
    ↓
[モジュールA/B/C] → 処理
    ↓
[Data Storage] → 保存（暗号化）
    ↓
[LLM] → 生成（必要に応じて）
    ↓
[UI] → 表示
```

---

## 4. AI/LLM 統合

### 4.1 役割

1. **ユーザー入力の理解**: 自然言語→構造化データ
2. **介入メッセージ生成**: 温かく・責めない文体
3. **書類ドラフト生成**: 研究メモリ→申請文書
4. **コンセプト抽出**: 断片→核心テーマ

### 4.2 技術選択肢

**クラウドAPI**:
- OpenAI GPT-4 / GPT-3.5
- Claude (Anthropic)

**ローカルモデル**:
- Llama 2 / 3
- Mistral
- (オフライン動作のため)

**ハイブリッド戦略**:
- 通常時: クラウドAPI
- オフライン時: ローカルモデル + キャッシュ応答

---

## 5. スケジューリング・定期実行

### 5.1 定期タスク

| タスク | 頻度 | モジュール | 目的 |
|--------|------|-----------|------|
| 朝の問い提示 | 毎朝9:00 | B | 研究マインドの再起動 |
| 夜の体調確認 | 毎晩22:00 | A | 1日の振り返り・危機チェック |
| 〆切リマインド | 毎朝 | C | 今日の最優先1タスク提示 |
| 危機モニタリング | 常時 | A | 入力があれば即座に判定 |

### 5.2 実装

- **Node.js**: `node-cron`
- **Python**: `APScheduler`

---

## 6. セキュリティ・プライバシー

### 6.1 データ保護

1. **ローカル優先**: データは原則ユーザーの端末のみに保存
2. **暗号化**: SQLCipher等でDB暗号化
3. **アクセス制御**: パスワード/PIN認証

### 6.2 外部通信

- LLM APIへの通信のみ（HTTPS）
- ユーザー識別子は匿名化
- ログは最小限に

### 6.3 データ主権

- ユーザーはいつでも全データをエクスポート可能（JSON形式）
- 削除機能（完全消去）
- 外部共有は明示的同意が必要

---

## 7. 技術スタック候補

### 7.1 バックエンド

- **言語**: Python 3.10+ or Node.js 18+
- **フレームワーク**: FastAPI (Python) / Express (Node.js)
- **DB**: SQLite + SQLCipher
- **スケジューラー**: APScheduler / node-cron

### 7.2 フロントエンド

- **Web**: React / Vue.js
- **デスクトップ**: Electron
- **モバイル**: React Native / Flutter
- **UI**: Tailwind CSS / Material-UI

### 7.3 AI/ML

- **LLM**: OpenAI API / Claude API
- **ローカル**: Llama.cpp / Ollama
- **ベクトル検索**: Chroma / FAISS（研究メモリの類似検索用）

---

## 8. 開発フェーズ

### Phase 1: ライフサポート MVP
- 体調ログ入力UI
- 危機検知ロジック
- 介入メッセージ生成
- 1日サマリー表示

**期間**: 2-3週間

### Phase 2: リサーチメモリ MVP
- 断片入力UI
- コンセプト抽出（LLM利用）
- 問いの再提示

**期間**: 2-3週間

### Phase 3: ソーシャルインターフェース MVP
- 〆切管理
- 優先度計算
- 書類ドラフト生成

**期間**: 3-4週間

### Phase 4: 統合・改善
- モジュール間連携強化
- UI/UX改善
- パーソナライゼーション学習

**期間**: 4週間〜

---

## 9. 成功指標（KPI）

### 定量指標

- 危機介入の頻度と翌日の再起率
- 研究メモリの累積数と再提示への反応率
- 〆切達成率

### 定性指標（最重要）

- **ユーザーの主観的実感**:
  - 「ARCがいて助かった」
  - 「自分を責めずに止まれた」
  - 「問いが消えなかった」
  - 「詰まなかった」

→ **定期的なフィードバックセッション（本人との対話）が必須**

---

## 10. リスク・制約

| リスク | 対策 |
|--------|------|
| LLM APIが落ちる | ローカルモデルのフォールバック |
| データ消失 | 自動バックアップ（暗号化） |
| 危機判断ミス | 医療判断はしない・窓口導線のみ |
| 依存しすぎ | 「ARCは補助」であることをUI上でリマインド |

---

**このアーキテクチャは、単なるアプリではなく、**  
**「人間が折れずに生き続けるための知的インフラ」として設計されている。**
